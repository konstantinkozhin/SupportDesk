<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –æ–±—É—á–µ–Ω–∏—è - Support Desk</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/navigation.js"></script>
    <script src="/static/menu_loader.js"></script>
    <script src="/static/notification.js"></script>
</head>
<body>
    <div class="layout">
        <!-- Top Navigation Bar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" style="text-decoration: none; color: inherit;">
                    <h1>Support Desk</h1>
                </a>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="main-nav" id="mainNav">
                        <!-- –ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <form method="post" action="/logout">
                    <button type="submit" class="logout-btn">
                        <span class="material-icons">logout</span>
                        <span class="btn-text">–í—ã–π—Ç–∏</span>
                    </button>
                </form>
            </div>
        </aside>

    <!-- Main Content -->
    <main class="main-content chat-page simulator-page">
        <div class="simulator-container">
            
            <!-- Character Selection Screen -->
            <div id="characterSelection" class="simulator-screen">
                <div class="simulator-hero">
                    <div class="simulator-hero-copy">
                        <h1 class="simulator-title">–°–∏–º—É–ª—è—Ç–æ—Ä –æ–±—É—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h1>
                        <p class="simulator-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–±—â–µ–Ω–∏—è –∏ —Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å –¥–∞–≤–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–µ, –∫–ª–∏–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.</p>
                    </div>
                </div>

                <div class="character-grid" id="characterGrid">
                    <!-- Characters will be loaded here -->
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="simulator-screen hidden">
                <section class="chat">
                    <div class="chat-top">
                        <header class="game-header">
                            <div class="header-left">
                                <div class="character-info" id="characterInfo">
                                    <span class="character-emoji">üôÇ</span>
                                    <span class="character-name">–ù–æ–≤–∏—á–æ–∫ –í–∞—Å—è</span>
                                </div>
                                
                                <div class="score-display">
                                    –ë–∞–ª–ª—ã: <span id="currentScore">0</span>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-label">
                                    –í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">5</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                            </div>
                            
                            <div class="header-right">
                                <button type="button" class="btn-hint" id="hintBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span class="btn-label">–ü–æ–¥—Å–∫–∞–∑–∫–∞</span>
                                </button>
                                
                                <button class="btn-end-game" id="endGameBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span class="btn-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
                                </button>
                            </div>
                        </header>
                    </div>

                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ - —Å–∫—Ä–æ–ª–ª—è—â–∞—è—Å—è –æ–±–ª–∞—Å—Ç—å -->
                    <div class="messages" id="chatMessages">
                        <!-- Messages will appear here -->
                    </div>
                    
                    <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ - –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É -->
                    <form class="reply-form" id="answerForm" autocomplete="off">
                        <div class="message-input-container">
                            <textarea 
                                id="answerInput" 
                                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."
                                rows="1"
                            ></textarea>
                            
                            <button type="submit" class="send-button" id="submitBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å (Enter)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                </section>
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="simulator-screen hidden">
                <div class="results-wrapper">
                    <div class="results-header">
                        <h2 class="results-title"><span class="material-icons">celebration</span> –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                        
                        <div class="results-stats">
                            <div class="result-stat">
                                <div class="result-stat-value" id="finalScore">0</div>
                                <div class="result-stat-label">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</div>
                            </div>
                            
                            <div class="result-stat">
                                <div class="result-stat-value" id="avgScore">0</div>
                                <div class="result-stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                            </div>
                            
                            <div class="result-stat">
                                <div class="result-stat-value" id="questionsAnswered">0</div>
                                <div class="result-stat-label">–í–æ–ø—Ä–æ—Å–æ–≤</div>
                            </div>
                        </div>
                    </div>

                    <div class="results-content">
                        <h3 class="results-section-title">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                        <div class="results-history" id="resultsHistory">
                            <!-- Detailed history will appear here -->
                        </div>
                    </div>

                    <div class="results-footer">
                        <button type="button" class="btn btn-soft-primary btn-large" id="restartBtn">
                            <span class="material-icons" aria-hidden="true">replay</span>
                            <span class="btn-label">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // State
        let currentSession = null;
        let currentQuestion = null;
        let currentCharacterEmoji = 'üôÇ';
        let currentCharacterName = '–°—Ç—É–¥–µ–Ω—Ç';

        // DOM Elements
        const characterSelection = document.getElementById('characterSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const characterGrid = document.getElementById('characterGrid');
        
        const characterInfo = document.getElementById('characterInfo');
        const currentQuestionEl = document.getElementById('currentQuestion');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const progressFill = document.getElementById('progressFill');
        const currentScoreEl = document.getElementById('currentScore');
        
        const chatMessages = document.getElementById('chatMessages');
        const answerInput = document.getElementById('answerInput');
        const answerForm = document.getElementById('answerForm');
        const hintBtn = document.getElementById('hintBtn');
        const submitBtn = document.getElementById('submitBtn');
        const endGameBtn = document.getElementById('endGameBtn');
        const restartBtn = document.getElementById('restartBtn');
        const hintButtonDefaultContent = hintBtn.innerHTML;
        const submitButtonDefaultContent = submitBtn.innerHTML;
        const submitButtonLoadingContent = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="spin-animation">
                <circle cx="12" cy="12" r="10" stroke-width="2" />
                <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round" />
            </svg>
        `;
        let canRespond = false;

        function resetAnswerInput() {
            answerInput.value = '';
            answerInput.style.height = 'auto';
        }

        function lockReply({showSpinner = false, clear = false} = {}) {
            canRespond = false;
            submitBtn.disabled = true;
            answerInput.disabled = true;
            if (showSpinner) {
                submitBtn.innerHTML = submitButtonLoadingContent.trim();
            }
            if (clear) {
                resetAnswerInput();
            }
        }

        function unlockReply({focus = true} = {}) {
            canRespond = true;
            submitBtn.disabled = false;
            answerInput.disabled = false;
            submitBtn.innerHTML = submitButtonDefaultContent;
            if (focus) {
                answerInput.focus();
            }
        }

        lockReply({clear: true});

        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        // Load characters on page load
        async function loadCharacters() {
            try {
                const response = await fetch('/api/simulator/characters');
                const data = await response.json();
                
                characterGrid.innerHTML = '';
                
                for (const [key, char] of Object.entries(data.characters)) {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    card.innerHTML = `
                        <div class="character-avatar">${char.emoji}</div>
                        <div class="character-card-body">
                            <h3 class="character-card-name">${char.name}</h3>
                            <p class="character-card-description">${char.description}</p>
                        </div>
                        <button class="btn btn-soft-primary btn-large btn-full" onclick="startSession('${key}')">
                            <span class="material-icons">play_arrow</span>
                            <span class="btn-label">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span>
                        </button>
                    `;
                    characterGrid.appendChild(card);
                }
            } catch (error) {
                console.error('Failed to load characters:', error);
                characterGrid.innerHTML = '<p class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>';
            }
        }

        // Start new session
        async function startSession(character) {
            try {
                // Get character info first
                const charsResponse = await fetch('/api/simulator/characters');
                const charsData = await charsResponse.json();
                const selectedChar = charsData.characters[character];
                
                // Save character info for messages
                currentCharacterEmoji = selectedChar.emoji;
                currentCharacterName = selectedChar.name;
                
                // Switch to game screen immediately with selected character
                hideElement(characterSelection);
                showElement(gameScreen);
                hideElement(resultsScreen);
                
                // Update UI with selected character immediately
                characterInfo.querySelector('.character-emoji').textContent = selectedChar.emoji;
                characterInfo.querySelector('.character-name').textContent = selectedChar.name;
                
                // Show loading message
                chatMessages.innerHTML = '';
                addTypingIndicator('user', selectedChar.emoji);
                lockReply({clear: true});
                
                const response = await fetch('/api/simulator/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({character})
                });
                
                const data = await response.json();
                currentSession = data;
                
                // Update remaining UI
                totalQuestionsEl.textContent = data.questions_total;
                currentQuestionEl.textContent = data.current_question;
                progressFill.style.width = `${(data.current_question / data.questions_total) * 100}%`;
                currentScoreEl.textContent = '0';
                
                // Remove typing indicator and show first question
                removeTypingIndicator();
                addMessage('user', data.question);
                resetAnswerInput();
                unlockReply();
                
            } catch (error) {
                console.error('Failed to start session:', error);
                removeTypingIndicator();
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏');
                lockReply({clear: true});
            }
        }
        
        // Add typing indicator
        function addTypingIndicator(role = 'user', emoji = 'üôÇ') {
            const typingDiv = document.createElement('div');
            let messageClass = 'chat-message-user';
            let avatarHtml = `<div class="message-avatar">${emoji}</div>`;

            if (role === 'system') {
                messageClass = 'chat-message-system';
                avatarHtml = `<div class="message-avatar"><span class="material-icons">stars</span></div>`;
            } else if (role === 'operator') {
                messageClass = 'chat-message-operator';
                avatarHtml = `<div class="message-avatar"><span class="material-icons">support_agent</span></div>`;
            }

            typingDiv.className = `typing-indicator ${messageClass}`;
            typingDiv.id = 'typingIndicator';
            
            const contentHtml = `
                <div class="message-content">
                    <div class="typing-bubble">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            // –î–ª—è operator –∏ mentor –∞–≤–∞—Ç–∞—Ä —Å–ø—Ä–∞–≤–∞
            if (role === 'operator' || role === 'mentor') {
                typingDiv.innerHTML = contentHtml + avatarHtml;
            } else {
                typingDiv.innerHTML = avatarHtml + contentHtml;
            }
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function buildSystemMessage(icon, title, body = '') {
            return `
                <span class="system-copy">
                    <strong>${title}</strong>
                    ${body ? `<span class="system-body">${body}</span>` : ''}
                </span>
            `;
        }

        function formatMultiline(text = '') {
            return text
                .split('\n')
                .map(line => line.trim())
                .filter(Boolean)
                .join('<br>');
        }

        function renderHistoryRow(icon, label, text) {
            return `
                <div class="history-row">
                    <span class="material-icons history-icon">${icon}</span>
                    <div class="history-content">
                        <strong>${label}</strong>
                        <span class="history-text">${text}</span>
                    </div>
                </div>
            `;
        }

        // Add message to chat with Telegram-style grouping
        let lastSender = null;
        let lastTimestamp = null;

        function addMessage(sender, text, isSystem = false) {
            const now = Date.now();
            const timeDiff = lastTimestamp ? (now - lastTimestamp) / 1000 : Infinity;
            const isSameSender = lastSender === sender;
            const isGrouped = isSameSender && timeDiff < 60;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-message-${sender}`;
            if (isSystem) messageDiv.classList.add('chat-message-system');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            if (isGrouped) {
                messageDiv.classList.add('grouped');
                // –£–±–∏—Ä–∞–µ–º show-avatar —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const previousMessage = chatMessages.lastElementChild;
                if (previousMessage && previousMessage.classList.contains('chat-message')) {
                    previousMessage.classList.remove('show-avatar', 'last-in-group');
                    previousMessage.classList.add('grouped');
                }
            }
            messageDiv.classList.add('last-in-group', 'show-avatar');

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (sender === 'user') {
                avatar.textContent = currentCharacterEmoji;
            } else if (sender === 'operator') {
                avatar.innerHTML = '<span class="material-icons">support_agent</span>';
            } else if (sender === 'system') {
                avatar.innerHTML = '<span class="material-icons">stars</span>';
            }

            const content = document.createElement('div');
            content.className = 'message-content';
            
            // –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            const senderName = document.createElement('div');
            senderName.className = 'message-sender-name';
            if (sender === 'user') {
                senderName.textContent = currentCharacterEmoji + ' ' + (currentCharacterName || '–°—Ç—É–¥–µ–Ω—Ç');
            } else if (sender === 'operator') {
                senderName.textContent = '–í—ã'; // –≠—Ç–æ –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (—É—á–µ–Ω–∏–∫–∞)
            } else if (sender === 'system') {
                senderName.textContent = '–°–∏—Å—Ç–µ–º–∞';
            }

            const textBlock = document.createElement('div');
            textBlock.className = 'message-text';
            if (isSystem) {
                textBlock.innerHTML = text;
            } else {
                textBlock.textContent = text;
            }
            
            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            content.appendChild(senderName);
            content.appendChild(textBlock);
            content.appendChild(meta);
            
            // –¢–æ–ª—å–∫–æ operator —Å–ø—Ä–∞–≤–∞ (–∞–≤–∞—Ç–∞—Ä –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–º, CSS row-reverse –ø–µ—Ä–µ–≤–µ—Ä–Ω–µ—Ç)
            // System, mentor, user - —Å–ª–µ–≤–∞ (–æ–±—ã—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
            if (sender === 'operator') {
                messageDiv.appendChild(avatar);  // Avatar first for row-reverse
                messageDiv.appendChild(content);
            } else {
                // –î–ª—è user, mentor, system - –æ–±—ã—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (—Å–ª–µ–≤–∞)
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            lastSender = sender;
            lastTimestamp = now;
        }

        // Submit answer
        async function submitAnswer(event) {
            if (event) {
                event.preventDefault();
            }

            if (!canRespond) {
                return;
            }
            
            const answer = answerInput.value.trim();
            if (!answer) {
                alert('–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
                return;
            }
            
            // Add operator's answer to chat
            addMessage('operator', answer);
            lockReply({showSpinner: true, clear: true});
            
            // Show typing indicator for evaluation (system is analyzing)
            addTypingIndicator('system');
            
            try {
                const response = await fetch('/api/simulator/respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({answer})
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Show evaluation
                showEvaluation(data);
                
                // Update score
                const currentScore = parseInt(currentScoreEl.textContent);
                currentScoreEl.textContent = currentScore + data.score;
                
            } catch (error) {
                console.error('Failed to submit answer:', error);
                removeTypingIndicator();
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                unlockReply({focus: false});
            }
        }
        
        answerForm.addEventListener('submit', submitAnswer);

        // Show evaluation results as chat messages
        function showEvaluation(data) {
            const scoreIcon = data.score >= 80 ? 'workspace_premium' : data.score >= 60 ? 'thumb_up' : 'edit_note';
            addMessage('system', buildSystemMessage(scoreIcon, `–û—Ü–µ–Ω–∫–∞: ${data.score} –±–∞–ª–ª–æ–≤`), true);

            addMessage(
                'system',
                buildSystemMessage('feedback', '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', formatMultiline(data.feedback)),
                true
            );

            addMessage(
                'system',
                buildSystemMessage('menu_book', '–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç', formatMultiline(data.ai_suggestion)),
                true
            );

            // Continue automatically
            if (!data.session_complete) {
                setTimeout(() => nextQuestion(data), 1500);
            } else {
                setTimeout(() => showResults(data), 1500);
            }
        }

        // Next question - automatic
        function nextQuestion(data) {
            // Update progress
            currentQuestionEl.textContent = data.current_question + 1;
            progressFill.style.width = `${((data.current_question + 1) / data.questions_total) * 100}%`;
            
            // Block input while showing new question
            lockReply();

            // Show typing indicator
            addTypingIndicator('user', currentCharacterEmoji);
            
            // Simulate typing delay, then show question
            setTimeout(() => {
                removeTypingIndicator();
                addMessage('user', data.next_question);
                resetAnswerInput();
                unlockReply();
            }, 800);
        }

        // Show results
        function showResults(data) {
            lockReply({clear: true});
            document.getElementById('finalScore').textContent = data.total_score;
            document.getElementById('avgScore').textContent = Math.round(data.average_score);
            document.getElementById('questionsAnswered').textContent = data.history.length;
            
            // Show detailed history
            const historyContainer = document.getElementById('resultsHistory');
            historyContainer.innerHTML = '';
            
            data.history.forEach((item, index) => {
                const scoreClass = item.score >= 80 ? 'excellent' : item.score >= 60 ? 'good' : 'poor';
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-number">–í–æ–ø—Ä–æ—Å ${index + 1}</span>
                        <span class="history-item-score history-score-${scoreClass}">${item.score} –±–∞–ª–ª–æ–≤</span>
                    </div>
                    ${renderHistoryRow('help', '–í–æ–ø—Ä–æ—Å', formatMultiline(item.question))}
                    ${renderHistoryRow('chat_bubble', '–í–∞—à –æ—Ç–≤–µ—Ç', formatMultiline(item.user_answer))}
                    ${renderHistoryRow('menu_book', '–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç', formatMultiline(item.ai_suggestion || item.ideal_answer || '–ù–µ —É–∫–∞–∑–∞–Ω'))}
                    ${renderHistoryRow('feedback', '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', formatMultiline(item.feedback))}
                `;
                historyContainer.appendChild(historyItem);
            });
            
            // Switch to results screen
            hideElement(gameScreen);
            showElement(resultsScreen);
        }

        // Get hint
        hintBtn.addEventListener('click', async () => {
            try {
                hintBtn.disabled = true;
                hintBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="spin-animation">
                        <circle cx="12" cy="12" r="10" stroke-width="2" />
                        <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="btn-label">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                `;
                
                const response = await fetch('/api/simulator/hint');
                const data = await response.json();
                
                // –í—ã—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã —Å—Ä–∞–∑—É
                const currentScore = parseInt(currentScoreEl.textContent);
                currentScoreEl.textContent = currentScore - 10;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —à—Ç—Ä–∞—Ñ–µ
                addMessage(
                    'system',
                    buildSystemMessage('lightbulb', '–ü–æ–¥—Å–∫–∞–∑–∫–∞ (‚àí10 –±–∞–ª–ª–æ–≤)', formatMultiline(data.hint)),
                    true
                );
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                hintBtn.disabled = false;
                hintBtn.innerHTML = hintButtonDefaultContent;
                
            } catch (error) {
                console.error('Failed to get hint:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏');
                hintBtn.disabled = false;
                hintBtn.innerHTML = hintButtonDefaultContent;
            }
        });

        // End game
        endGameBtn.addEventListener('click', async () => {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/simulator/end', {method: 'POST'});
                const data = await response.json();
                
                if (data.stats) {
                    showResults(data.stats);
                } else {
                    restartGame();
                }
            } catch (error) {
                console.error('Failed to end game:', error);
                restartGame();
            }
        });

        // Restart game
        restartBtn.addEventListener('click', restartGame);

        function restartGame() {
            showElement(characterSelection);
            hideElement(gameScreen);
            hideElement(resultsScreen);
            currentSession = null;
            lockReply({clear: true});
            loadCharacters();
        }

        // Initialize
        loadCharacters();
        
        // Auto-resize textarea
        answerInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // Submit on Enter (without Shift)
        answerInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (canRespond) {
                    answerForm.dispatchEvent(new Event('submit'));
                }
            }
        });
    </script>
    </div> <!-- .layout -->
    <footer class="site-footer">
        <p>¬© 2025 –¶–µ–Ω—Ç—Ä –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –°–§–£</p>
    </footer>
</body>
</html>
