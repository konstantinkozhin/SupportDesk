# AI Support Desk System - Prototype

Система технической поддержки с интеграцией AI-агента, поддержкой нескольких каналов коммуникации и автоматической базой знаний.

## Технологический стек

### Backend
- **FastAPI** - веб-фреймворк для API и веб-интерфейса
- **Python 3.11** - основной язык программирования
- **SQLAlchemy** - ORM для работы с базами данных
- **SQLite** - три базы данных:
  - `tickets.db` - заявки и сообщения
  - `knowledge.db` - база знаний (документы, чанки, эмбеддинги)
  - `users.db` - пользователи и права доступа

### AI/ML компоненты
- **LLM модели** (OpenAI-совместимый API):
  - Gemma 3 27B (основная модель для диалогов)
  - Gemma 3 9B (альтернативная модель)

- **SentenceTransformers** - генерация эмбеддингов (all-MiniLM-L6-v2)
- **FAISS** - векторный поиск по базе знаний
- **Rank-BM25** - гибридный поиск (BM25 + семантический)
- **OpenAI Whisper** - распознавание речи (модель: small/medium)
- **agno** - фреймворк для MCP (Model Context Protocol) агента

### Боты и каналы коммуникации
- **Telegram Bot** (aiogram 3.x) - основной канал
- Веб-интерфейс (FastAPI + Jinja2)

### Хранилище и индексация
- **FAISS** - векторная база для семантического поиска
- **BM25** - лексический поиск
- **Hybrid search** - комбинация векторного и BM25 поиска

### Инфраструктура
- **Docker & Docker Compose** - контейнеризация
- **ngrok** - туннелирование для локальной разработки
- **uvicorn** - ASGI сервер

## MCP (Model Context Protocol) функции

Агент использует следующие инструменты через декоратор `@tool`:

### 1. Поиск и работа с знаниями
- `search_knowledge_base(query, suggest_similar)` - поиск решений в базе знаний
- `improve_search_query(original_query, context)` - улучшение поискового запроса через LLM
- `save_case_to_knowledge_base(problem_description, solution)` - сохранение решенных кейсов

### 2. Классификация и приоритизация
- `classify_request(dialogue_history, text, categories)` - классификация запроса по категориям
- `set_priority(dialogue_history)` - определение приоритета (низкий/средний/высокий)

### 3. Управление заявками
- `create_it_ticket(problem_description, location)` - создание заявки на выезд IT-специалиста
- `call_operator()` - передача сложного запроса живому оператору

### 4. Отчетность и мониторинг
- `get_support_report()` - детальный отчет о состоянии службы поддержки
- `get_system_status()` - проверка статуса системы

Все инструменты интегрированы с системой уведомлений - действия агента отображаются в Telegram для прозрачности работы.

## Основные функции системы

### Для пользователей
1. **Многоканальная поддержка**
   - Telegram бот с голосовыми сообщениями
   - VK бот для групп
   - Веб-интерфейс

2. **AI-ассистент**
   - Автоматические ответы на основе базы знаний
   - Классификация запросов
   - Определение приоритета
   - Предложение похожих решений

3. **Распознавание речи**
   - Поддержка голосовых сообщений через Whisper
   - Локальное распознавание (не требует интернета после загрузки модели)
   - Поддержка языков: русский, английский, украинский, белорусский, казахский

4. **FAQ (автоматическая генерация)**
   - Страница с часто задаваемыми вопросами
   - Обновляется автоматически на основе популярных запросов
   - Умный поиск по ключевым словам

### Для операторов
1. **Dashboard**
   - Статистика заявок (всего, сегодня, открытых)
   - Графики: заявки за 30 дней, время отклика/обработки
   - Активные диалоги по категориям и приоритетам
   - Распределение по классификациям

2. **Управление заявками**
   - Просмотр всех заявок с фильтрацией
   - Чат с пользователями в реальном времени
   - Передача заявок между операторами
   - WebSocket для живых обновлений

3. **База знаний**
   - Загрузка документов (DOCX, PDF, TXT, XLSX)
   - Автоматическая разбивка на чанки
   - Генерация эмбеддингов для поиска
   - Управление записями

4. **Симулятор пользователей**
   - Генерация синтетических запросов
   - Тестирование работы AI-агента
   - Проверка качества ответов

### Для администраторов
1. **Управление пользователями**
   - Создание/редактирование учетных записей
   - Назначение ролей (admin, operator, viewer)
   - Аутентификация с bcrypt

2. **Настройка системы**
   - Конфигурационные файлы YAML:
     - `app_config.yaml` - общие настройки, речь, сессии
     - `rag_config.yaml` - настройки AI, категории, промпты
     - `simulator_config.yaml` - симулятор запросов
   - Переменные окружения через `.env`

## Архитектура

### RAG (Retrieval-Augmented Generation)
1. **Гибридный поиск**
   - Векторный поиск (FAISS + SentenceTransformers)
   - Лексический поиск (BM25)
   - Комбинированное ранжирование результатов

2. **Чанкинг документов**
   - Рекурсивная разбивка текста
   - Настраиваемый размер чанков (по умолчанию 500 символов)
   - Overlap для контекста между чанками

3. **Эмбеддинги**
   - Модель: `all-MiniLM-L6-v2` (384 измерения)
   - Быстрая генерация и компактное хранение
   - Кеширование для производительности

### Agent workflow
1. Пользователь отправляет запрос
2. Агент анализирует запрос и выбирает инструменты
3. Выполняются MCP функции (поиск, классификация, приоритет)
4. LLM генерирует финальный ответ на основе найденной информации
5. Действия агента отображаются в интерфейсе

### WebSocket real-time updates
- Новые сообщения в заявках
- Обновление статусов
- Уведомления операторов
- Broadcast для множественных клиентов

## Конфигурация

### Модель LLM
Система поддерживает OpenAI-совместимые API. Конфигурация в `.env`:

```bash
LLM_API_KEY=your_api_key
LLM_API_BASE=https://api.example.com/v1 # можно использовать https://demo.ai.sfu-kras.ru/v1
LLM_MODEL=gemma-3-27b 
```

Доступные модели:
- **gemma-3-27b** - основная рабочая модель 
- **gemma-3-9b** - более простая альтернатива

### Whisper модели
Конфигурация в `configs/app_config.yaml`:

```yaml
speech:
  enabled: true
  language: "ru"
  whisper_model: "small"  # tiny, base, small, medium, large
  ffmpeg_path: ""  # auto-detect или явный путь
```

Размеры моделей:
- **tiny** (39MB) - быстро, низкое качество
- **base** (74MB) - базовое качество
- **small** (244MB) - хорошее качество, рекомендуется для большинства случаев
- **medium** (1.5GB) - отличное качество
- **large** (2.9GB) - максимальное качество, требует много памяти

### FAQ автогенерация
```yaml
faq:
  update_interval_minutes: 5  # частота обновления
  top_chunks_count: 10  # количество популярных чанков для FAQ
```

Система автоматически отслеживает популярные запросы и генерирует FAQ на основе самых используемых решений.

## Deployment

### Локальный запуск (без Docker)

1. Установка зависимостей:
```bash
pip install -r requirements.txt
```

2. Настройка `.env`:
```bash
cp .env.example .env
# Отредактировать .env с вашими токенами
```

3. Запуск:
```bash
uvicorn app.main:app --reload
```

### Docker Compose (рекомендуется)

1. Настройка `.env`:
```bash
cp .env.example .env
# Заполнить LLM_API_KEY, TELEGRAM_BOT_TOKEN и другие обязательные поля
```

2. Запуск:
```bash
docker-compose up -d
```

3. Проверка:
```bash
docker-compose logs -f app
```

Контейнер включает:
- Автоматическую установку зависимостей
- FFmpeg для Whisper
- Volume для кеша моделей Whisper (~1.5GB)
- Hot-reload для разработки

### Порты
- **8000** - веб-интерфейс и API
- **4040** - ngrok inspector (если используется)

## База данных

### Структура
1. **tickets.db**
   - `tickets` - заявки с метаданными
   - `messages` - сообщения в заявках
   - `tickets_classifications` - связь заявок и категорий

2. **knowledge.db**
   - `document_chunks` - чанки документов с эмбеддингами
   - `faiss_index` - векторный индекс (хранится отдельно)

3. **users.db**
   - `users` - учетные записи операторов

### Миграции
Система автоматически создает таблицы при первом запуске. Скрипты миграций находятся в `scripts/`:
- `create_knowledge_db.py` - инициализация базы знаний
- `create_users_system.py` - создание системы пользователей
- `migrate_add_chunks_table.py` - добавление таблицы чанков

## API Endpoints

### Public
- `GET /` - главная страница
- `GET /faq` - страница FAQ
- `GET /api/faq` - получить FAQ (JSON)
- `GET /api/faq/search?q=query` - поиск в FAQ

### Protected (требуется аутентификация)
- `GET /dashboard` - дашборд статистики
- `GET /chat` - интерфейс заявок
- `GET /knowledge` - управление базой знаний
- `GET /simulator` - симулятор запросов
- `GET /admin/users` - управление пользователями

### API
- `GET /api/dashboard/stats` - статистика для дашборда
- `GET /api/dashboard/active_sessions` - активные диалоги
- `POST /api/knowledge/upload` - загрузка документа
- `WebSocket /ws/{ticket_id}` - real-time обновления заявки

## Безопасность

- **Аутентификация**: сессии на основе cookies
- **Хеширование паролей**: bcrypt
- **SECRET_KEY**: обязательно изменить в продакшене
- **HTTPS**: рекомендуется для продакшена
- **CORS**: настроить для API если требуется

## Мониторинг и логирование

### Логи
- Хранятся в `logs/app.log`
- Ротация: 10MB x 5 файлов
- Уровень: INFO для файла, INFO для консоли

### Метрики (через Dashboard)
- Количество заявок (всего, сегодня, открытых)
- Среднее время отклика
- Среднее время обработки
- Распределение по категориям
- Активные сессии по приоритетам

## Разработка

### Структура проекта
```
app/
  auth/          - аутентификация и права доступа
  bots/          - Telegram и VK боты
  db/            - модели БД, CRUD операции
  rag/           - RAG система, агент, инструменты
  services/      - WebSocket, симулятор
  static/        - CSS, JS для веб-интерфейса
  templates/     - HTML шаблоны (Jinja2)
  utils/         - утилиты (URL helper)
  config.py      - загрузка конфигураций
  main.py        - FastAPI приложение

configs/         - YAML конфигурации
db/              - SQLite базы данных
docs/            - документация
logs/            - логи приложения
scripts/         - утилиты и миграции
tools/           - вспомогательные инструменты (ngrok)
```

### Настройка промптов
Все промпты для агента находятся в `configs/rag_config.yaml`:
- `system_prompt` - основная инструкция для агента
- `classification_prompt` - промпт классификации
- `set_priority_prompt` - промпт определения приоритета
- `improve_search_prompt` - промпт улучшения запроса

## Ограничения текущей версии (Prototype)

1. **Масштабируемость**
   - SQLite не подходит для высоких нагрузок
   - Рекомендуется PostgreSQL для продакшена
   - Один процесс FastAPI (нет горизонтального масштабирования)

2. **Производительность**
   - Whisper работает на CPU (медленно для больших файлов)
   - FAISS индекс загружается в память целиком
   - Синхронные операции с базой данных могут блокировать

3. **Функциональность**
   - Нет поддержки вложений в веб-интерфейсе
   - Ограниченная поддержка мультимодальности
   - Отсутствует система нотификаций email

4. **Безопасность**
   - Простая система аутентификации (сессии)
   - Нет rate limiting
   - Нет защиты от CSRF (для production нужно добавить)
